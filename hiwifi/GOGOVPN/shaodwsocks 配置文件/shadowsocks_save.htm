<%
--[[

]]--
local ver  = require "luci.version"
local adv_menu = luci.util.get_adv_menu()
local request_uri = luci.http.getenv("REQUEST_URI")
local formaction=luci.http.formvalue("submit")
local reminding=""
%>
<%

if formaction=="保存" then
    form_ss_server_name=luci.http.formvalue("ss_server_name")
    form_ss_server_des=luci.http.formvalue("ss_server_des")
    form_ss_server_ip=luci.http.formvalue("ss_server_ip")
    form_ss_server_port=luci.http.formvalue("ss_server_port")
    form_ss_password=luci.http.formvalue("ss_password")
    form_ss_method=luci.http.formvalue("ss_method")
    form_ss_mode=luci.http.formvalue("ss_mode")
    form_ss_enable=luci.http.formvalue("enable")
    form_antixxx_dns_server_ip=luci.http.formvalue("antixxx_dns_server_ip")
    luci_cmd="uci set ss-redir."..form_ss_server_name..".ss_server_des="..form_ss_server_des
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir."..form_ss_server_name..".ss_server_ip="..form_ss_server_ip
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir."..form_ss_server_name..".ss_server_port="..form_ss_server_port
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir."..form_ss_server_name..".ss_password="..form_ss_password
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir."..form_ss_server_name..".ss_method="..form_ss_method
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir.ssgoabroad.mode="..form_ss_mode
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir.ssgoabroad.antixxx_dns_server_ip="..form_antixxx_dns_server_ip
    luci.sys.exec(luci_cmd)
    luci_cmd="uci commit ss-redir"
    luci.sys.exec(luci_cmd)
    reminding="保存成功"
    luci_cmd="/etc/init.d/ss-redir "..form_ss_enable
    luci.sys.exec(luci_cmd)
elseif formaction=="保存并启动" then
    form_ss_server_name=luci.http.formvalue("ss_server_name")
    form_ss_server_des=luci.http.formvalue("ss_server_des")
    form_ss_server_ip=luci.http.formvalue("ss_server_ip")
    form_ss_server_port=luci.http.formvalue("ss_server_port")
    form_ss_password=luci.http.formvalue("ss_password")
    form_ss_method=luci.http.formvalue("ss_method")
    form_ss_mode=luci.http.formvalue("ss_mode")
    form_ss_enable=luci.http.formvalue("enable")
    form_antixxx_dns_server_ip=luci.http.formvalue("antixxx_dns_server_ip")
    luci_cmd="uci set ss-redir."..form_ss_server_name..".ss_server_des="..form_ss_server_des
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir."..form_ss_server_name..".ss_server_ip="..form_ss_server_ip
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir."..form_ss_server_name..".ss_server_port="..form_ss_server_port
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir."..form_ss_server_name..".ss_password="..form_ss_password
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir."..form_ss_server_name..".ss_method="..form_ss_method
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir.ssgoabroad.mode="..form_ss_mode
    luci.sys.exec(luci_cmd)
    luci_cmd="uci set ss-redir.ssgoabroad.antixxx_dns_server_ip="..form_antixxx_dns_server_ip
    luci.sys.exec(luci_cmd)
    luci_cmd="uci commit ss-redir"
    luci.sys.exec(luci_cmd)
    luci_cmd="/etc/init.d/ss-redir "..form_ss_enable
    luci.sys.exec(luci_cmd)
    luci.sys.exec("/etc/init.d/ss-redir restart")
    reminding="保存成功，已启动"

elseif formaction=="启动" then
    luci.sys.exec("/etc/init.d/ss-redir restart")
    reminding="启动成功"

elseif formaction=="停止" then
    luci.sys.exec("/etc/init.d/ss-redir stop")
    reminding="停止成功"

elseif formaction=="切换" then
    form_ss_server_name=luci.http.formvalue("ss_server_name")
    luci_cmd="uci set ss-redir.ssgoabroad.ss_server_name="..form_ss_server_name
    luci.sys.exec(luci_cmd)
    luci_cmd="uci commit ss-redir"
    luci.sys.exec(luci_cmd)
    luci.sys.exec("/etc/init.d/ss-redir stop")
    reminding="切换服务器成功"
elseif formaction=="切换并启动" then
    form_ss_server_name=luci.http.formvalue("ss_server_name")
    luci_cmd="uci set ss-redir.ssgoabroad.ss_server_name="..form_ss_server_name
    luci.sys.exec(luci_cmd)
    luci_cmd="uci commit ss-redir"
    luci.sys.exec(luci_cmd)
    luci.sys.exec("/etc/init.d/ss-redir restart")
    reminding="切换服务器成功，已启动"

elseif formaction=="保存防污染域名列表" then
    form_antixxx_domain_list=luci.http.formvalue("antixxx_domain_list")
    local temp = io.output()
    io.output("/etc/SSdiyDNS.conf")
    io.write(form_antixxx_domain_list)
    io.output():close()
    io.output(temp) 
    luci.sys.exec("/etc/init.d/ss-redir restart") 
    reminding="保存防污染域名列表成功"
else
end
%>
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="refresh" content="2;url=shadowsocks"> 
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="format-detection" content="telephone=no" />
<title>HiWiFi 路由器</title>
<link rel="stylesheet" href="<%=resource%>/web/css/style.css?v=<%=ver.svnRevNum%>" type="text/css"/>
<script type="text/javascript" src="<%=resource%>/web/js/jquery-1.8.1.min.js?v=<%=ver.svnRevNum%>"></script>
<script type="text/javascript" src="<%=resource%>/web/js/artDialog/jquery.artDialog.js?skin=blueskin"></script>
<script src="<%=resource%>/web/js/artDialog/plugins/iframeTools.source.js?v=<%=ver.svnRevNum%>"></script>
</head>

<style type="text/css">
table.zone td.tor{
text-align: right;
width:120px;
line-height:14px;
}
#con_stauts{
width:300px;
}
.error-box {
text-align: center;
color: #d84613;
font-size: 14px;
.sstestresult-table{ border-top: 1px solid #eee;border-collapse:collapse;margin:10px auto;}
.sstestresult-table th, .sstestresult-table td{ border-bottom: 1px solid #eee;border-left: 1px solid #eee;border-right: 1px solid #eee; text-align: left; padding: 8px; font-size: 12px; color: #666;}
.sstestresult-table th{ font-weight: 700; color: #333; background: #f9f9f9;}
}
</style>
<body>
<div class="title">
<h2>高级设置<i>设置路由器安全 , 及其他高级设置</i></h2>
</div>
<div class="menu">
        <% include("admin_web/menu/adv_menu") %>
</div>

<div class="box setup_box">
                <ul class="ullist" style="position:relative">
            <li class="error-box">
                <div class="info">
                    <p><%=reminding%></p>
		    <p></p>
		<%
		if formaction=="保存并启动" or formaction=="启动" or formaction=="切换并启动" or formaction=="保存防污染域名列表" then
		%>
		<p><span id="totalSecond" >正在进行账号测试，预计10秒钟后完成</span></p>   
		<%
		else
		%>
		 <p><span id="totalSecond"  style="display:none;" >正在进行账号测试，预计10秒钟后完成</span></p>
                <%
		
		end
		%>
		</div>
            </li>
</ul>
</div>

 
<script language="javascript" type="text/javascript"> 
var second = 2; 
 
if (navigator.appName.indexOf("Explorer") > -1)  { 
    second = document.getElementById('totalSecond').innerText; 
} else { 
    second = document.getElementById('totalSecond').textContent; 
} 
 
setInterval("redirect()", 1000); 
function redirect() { 
if (second < 0) { 
    location.href = 'shadowsocks'; 
} else { 
    if (navigator.appName.indexOf("Explorer") > -1) { 
        second--
        document.getElementById('totalSecond').innerText = '测速已完成，正在返回'; 
    } else { 
        second--
        document.getElementById('totalSecond').textContent = '测速已完成，正在返回'; 
    } 
} 
} 
</script>
</body>
</html>
<%
if formaction=="保存并启动" or formaction=="启动" or formaction=="切换并启动" or formaction=="保存防污染域名列表" then
	testresult="<p><label>最近一次启动时的测试结果<\/label><\/p>"
	testresult=testresult.."<table class=sstestresult-table><tr><th>站点<\/th><th>Http代码<\/th><th>打开总时长s<\/th><th>页面大小B<\/th><th>下载速度B\/s<\/th><\/tr>"
	testresult=testresult..luci.sys.exec("curl -s -k -m 10 -o /dev/null -w '<tr><td>facebook<\/><td>'%{http_code}'<\/td><td>'%{time_total}'<\/td><td>'%{size_download}'<\/td><td>'%{speed_download}'<\/td><\/tr>' https://www.facebook.com")
	testresult=testresult..luci.sys.exec("curl -s -k -m 10 -o /dev/null -w '<tr><td>youtube<\/><td>'%{http_code}'<\/td><td>'%{time_total}'<\/td><td>'%{size_download}'<\/td><td>'%{speed_download}'<\/td><\/tr>' https://www.youtube.com")
	testresult=testresult.."<\/table>"
	local temp = io.output()
	io.output("/tmp/sstest.result")
	io.write(testresult)
	io.output():close()
	io.output(temp)
else
	local temp = io.output()
        io.output("/tmp/sstest.result")
        io.write("")
        io.output():close()
        io.output(temp)
end

%>
